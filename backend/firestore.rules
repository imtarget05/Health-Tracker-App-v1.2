rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Allow users to read/write only their own user document
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;

      // For create and update, require the user to be authenticated and only
      // allow writes that set/merge fields for the user's own doc.
      allow create, update: if request.auth != null
        && request.auth.uid == userId
        && isValidUserPayload(request.resource);

      // Allow delete only for admin users (example) â€” keep conservative by default
      allow delete: if false;
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// Helper function to validate a user document payload. Adjust rules below
// to match the shape your client writes. Keep them permissive for nested
// profile partials but enforce basic types and limits.
function isValidUserPayload(resource) {
  // Must include a lastUpdated timestamp if present, and if present it must be a timestamp
  let lastOk = !('lastUpdated' in resource.data) || resource.data.lastUpdated is timestamp;

  // If 'profile' object exists, validate its fields
  let profileOk = true;
  if ('profile' in resource.data) {
    profileOk = (
      (!('name' in resource.data.profile) || resource.data.profile.name is string)
      && (!('email' in resource.data.profile) || resource.data.profile.email is string)
      && (!('avatar' in resource.data.profile) || resource.data.profile.avatar is string)
      && (!('weight' in resource.data.profile) || resource.data.profile.weight is number)
      && (!('height' in resource.data.profile) || resource.data.profile.height is number)
    );
  }

  // If 'habit' object exists, validate basic fields
  let habitOk = true;
  if ('habit' in resource.data) {
    habitOk = (
      (!('sleepHours' in resource.data.habit) || resource.data.habit.sleepHours is number)
      && (!('waterMl' in resource.data.habit) || resource.data.habit.waterMl is number)
    );
  }

  return lastOk && profileOk && habitOk;
}
